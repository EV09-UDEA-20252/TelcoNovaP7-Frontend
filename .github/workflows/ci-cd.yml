name: CI/CD
on:
 push:
  branches:
    - develop-pruebas
env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
jobs:
    unit-tests:
        name: Unit tests
        runs-on: ubuntu-latest
        permissions:
          contents: read
          pull-requests: write
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Use Node.js 22
            uses: actions/setup-node@v3
            with:
              node-version: '22'
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Run unit tests (Vitest)
            run: npx vitest --run --coverage
    sonar:
      name: SonarCloud
      runs-on: ubuntu-latest
      needs: unit-tests
      permissions:
        contents: read
        pull-requests: write
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Use Node.js 22
          uses: actions/setup-node@v3
          with:
            node-version: '22'
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Cache Sonar cache
          uses: actions/cache@v4
          with:
            path: ~/.sonar/cache
            key: ${{ runner.os }}-sonar
            restore-keys: ${{ runner.os }}-sonar

        - name: SonarCloud Scan
          uses: SonarSource/sonarcloud-github-action@v2
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            args: >
              -Dsonar.projectKey=telconova_telconovafrontend
              -Dsonar.organization=telconova
              -Dsonar.host.url=https://sonarcloud.io
              -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
    build:
        name: Build and Deploy
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/integration/cristian'
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js 22
              uses: actions/setup-node@v3
              with:
                node-version: '22'
            - name: Install dependencies
              run: npm install
            - name: Build project
              run: npm run build
    Deploy-Dev:
        name: Deploy to Vercel (Development)
        needs: build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/integration/cristian'
        steps:
            - uses: actions/checkout@v3
            - name: use Node.js 22
              uses: actions/setup-node@v3
              with:
                node-version: '22'
            - name: Install vercel Cli
              run: npm install --global vercel@latest
            - name: Pull Vercel Environmental Variables  
              run: vercel pull --yes --token=${{ secrets.VERCEL_TOKEN }}
            - name: Trigger Vercel Deployment
              run: vercel deploy --no-wait --token=${{ secrets.VERCEL_TOKEN }}
    Deploy-Production:
        name: Deploy to Vercel (Production)
        needs: build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v3
            - name: use Node.js 22
              uses: actions/setup-node@v3
              with:
                node-version: '22'
            - name: Install vercel Cli
              run: npm install --global vercel@latest
            - name: Pull Vercel Environmental Variables  
              run: vercel pull --yes --token=${{ secrets.VERCEL_TOKEN }}
            - name: Trigger Vercel Deployment

              run: vercel deploy --prod --no-wait --token=${{ secrets.VERCEL_TOKEN }}




